#!/bin/sh

echo "ğŸš€ Pre-commit E2E checks starting..."

# Run lint-staged for automatic fixes
echo "ğŸ“ Running automatic fixes on staged files..."
npx lint-staged

# Additional comprehensive checks
echo "ğŸ” Running comprehensive quality checks..."

# Run type check on entire project
echo "ğŸ”§ TypeScript type checking..."
if ! pnpm type-check; then
  echo "âŒ Type check failed. Please fix TypeScript errors before committing."
  exit 1
fi

# Run all tests with consistent environment variables (same as CI)
echo "ğŸ§ª Running unit tests..."
if ! pnpm test:ci; then
  echo "âŒ Unit tests failed. Please fix failing tests before committing."
  exit 1
fi

# Run E2E tests with automatic server startup
echo "ğŸŒ Running E2E tests with automatic server startup..."
echo "â³ This may take a few minutes..."

# Set environment for automatic server startup
export NODE_ENV=test
export NEXT_TELEMETRY_DISABLED=1

# Run E2E tests with timeout
if timeout 300 pnpm test:e2e:ci basic.spec.ts; then
  echo "âœ… E2E tests passed!"
else
  echo "âš ï¸ E2E tests failed or timed out (5 minutes)"
  echo "ğŸ’¡ You can still commit, but consider running 'pnpm test:e2e:verbose' manually"
  
  # Ask user if they want to continue
  echo "â“ Continue with commit anyway? (y/N)"
  read -r response
  if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
    echo "âŒ Commit aborted by user"
    exit 1
  fi
fi

echo "âœ… All pre-commit checks passed!"
echo "ğŸ‰ Ready to commit!"