#!/bin/bash

# Post-merge hook for automatic cleanup after PR merge
# PRãŒdevelopã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸå¾Œã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

set -e

# è‰²ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ã®é–¢æ•°
print_info() {
    echo -e "\033[36m[AUTO-CLEANUP]\033[0m $1"
}

print_success() {
    echo -e "\033[32m[AUTO-CLEANUP]\033[0m $1"
}

print_warning() {
    echo -e "\033[33m[AUTO-CLEANUP]\033[0m $1"
}

print_error() {
    echo -e "\033[31m[AUTO-CLEANUP]\033[0m $1"
}

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
CURRENT_BRANCH=$(git branch --show-current)

print_info "ğŸ¤– Auto-cleanup triggered after merge"
print_info "Current branch: $CURRENT_BRANCH"

# developãƒ–ãƒ©ãƒ³ãƒã¾ãŸã¯feature/hotfix/choreãƒ–ãƒ©ãƒ³ãƒã§ã®è‡ªå‹•å®Ÿè¡Œ
if [ "$CURRENT_BRANCH" != "develop" ] && [[ ! "$CURRENT_BRANCH" =~ ^(feature|hotfix|chore)/ ]]; then
    print_info "Not on develop or feature branch, skipping auto-cleanup"
    exit 0
fi

# feature/hotfix/choreãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã¯ã€developã«ãƒãƒ¼ã‚¸å®Œäº†å¾Œã®å‡¦ç†ã¨ã—ã¦å®Ÿè¡Œ
if [[ "$CURRENT_BRANCH" =~ ^(feature|hotfix|chore)/ ]]; then
    print_info "Running post-merge cleanup for feature branch: $CURRENT_BRANCH"
    
    # developãƒ–ãƒ©ãƒ³ãƒã«åˆ‡ã‚Šæ›¿ãˆã¦æœ€æ–°ã‚’å–å¾—
    print_info "Switching to develop branch for cleanup..."
    git fetch origin
    git checkout develop
    git pull origin develop
    
    # å…ƒã®ãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤å¯¾è±¡ã¨ã—ã¦è¨­å®š
    MERGED_BRANCH="$CURRENT_BRANCH"
    
    # å‰Šé™¤å‡¦ç†ã«ã‚¹ã‚­ãƒƒãƒ—
    print_success "âœ… Detected completed work on branch: $MERGED_BRANCH"
    
else
    # é€šå¸¸ã®developãƒ–ãƒ©ãƒ³ãƒã§ã®ãƒãƒ¼ã‚¸å‡¦ç†
    # ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã‹ã©ã†ã‹ç¢ºèªï¼ˆ2ã¤ä»¥ä¸Šã®è¦ªã‚³ãƒŸãƒƒãƒˆã‚’æŒã¤ï¼‰
    PARENT_COUNT=$(git log -1 --pretty=format:"%P" | wc -w)
    if [ "$PARENT_COUNT" -lt 2 ]; then
        print_info "Not a merge commit, skipping auto-cleanup"
        exit 0
    fi
fi

# feature/hotfix/choreãƒ–ãƒ©ãƒ³ãƒä»¥å¤–ã®å ´åˆã®ã¿ãƒ–ãƒ©ãƒ³ãƒåã‚’æ¤œå‡º
if [[ ! "$CURRENT_BRANCH" =~ ^(feature|hotfix|chore)/ ]]; then
    # ãƒãƒ¼ã‚¸ã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—ï¼ˆè¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œï¼‰
    MERGED_BRANCH=""

    # GitHub merge commit pattern: "Merge pull request #123 from user/branch-name"
    MERGED_BRANCH=$(git log --merges -1 --pretty=format:"%s" | sed -n 's/.*from [^/]*\/\(.*\)/\1/p')

    # Git merge pattern: "Merge branch 'branch-name' into develop"
    if [ -z "$MERGED_BRANCH" ]; then
        MERGED_BRANCH=$(git log --merges -1 --pretty=format:"%s" | sed -n "s/.*branch '\([^']*\)'.*/\1/p")
    fi

    # Fast-forward merge ã®å ´åˆã€å‰ã®ã‚³ãƒŸãƒƒãƒˆã‹ã‚‰æ¨æ¸¬
    if [ -z "$MERGED_BRANCH" ]; then
        print_info "Could not determine merged branch name from merge commit"
        print_info "Trying alternative detection method..."
        
        # æœ€è¿‘å‰Šé™¤ã•ã‚ŒãŸãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’ç¢ºèª
        RECENT_BRANCHES=$(git for-each-ref --format='%(refname:short) %(committerdate:iso8601)' refs/remotes/origin | grep -v 'origin/develop\|origin/main' | sort -k2 -r | head -3)
        if [ -n "$RECENT_BRANCHES" ]; then
            print_info "Recent remote branches:"
            echo "$RECENT_BRANCHES"
        fi
        
        print_info "Auto-cleanup cannot determine target branch"
        print_info "ğŸ’¡ Manual cleanup: npm run cleanup:smart"
        exit 0
    fi
fi

if [ "$MERGED_BRANCH" = "develop" ] || [ "$MERGED_BRANCH" = "main" ]; then
    print_info "Merged branch is $MERGED_BRANCH (main branch), skipping cleanup"
    exit 0
fi

print_success "âœ… Detected merge of branch: $MERGED_BRANCH"

# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
if git show-ref --verify --quiet refs/heads/"$MERGED_BRANCH"; then
    print_info "ğŸ—‘ï¸ Deleting local branch: $MERGED_BRANCH"
    git branch -d "$MERGED_BRANCH" 2>/dev/null || {
        print_warning "Failed to delete with -d, trying -D (force delete)..."
        git branch -D "$MERGED_BRANCH"
    }
    print_success "âœ… Local branch '$MERGED_BRANCH' deleted"
else
    print_info "Local branch '$MERGED_BRANCH' not found (may have been deleted already)"
fi

# ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦å‰Šé™¤
if git show-ref --verify --quiet refs/remotes/origin/"$MERGED_BRANCH"; then
    # GitHub CLIãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦PRã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
    if command -v gh &> /dev/null; then
        PR_STATE=$(gh pr view "$MERGED_BRANCH" --json state -q .state 2>/dev/null || echo "NOT_FOUND")
        if [ "$PR_STATE" = "MERGED" ]; then
            print_info "ğŸ—‘ï¸ Deleting remote branch: origin/$MERGED_BRANCH"
            git push origin --delete "$MERGED_BRANCH" 2>/dev/null || {
                print_warning "Failed to delete remote branch (may have been deleted already)"
            }
            print_success "âœ… Remote branch 'origin/$MERGED_BRANCH' deleted"
        else
            print_info "PR not merged, keeping remote branch"
        fi
    else
        print_info "GitHub CLI not found, keeping remote branch for safety"
        print_info "ğŸ’¡ Install GitHub CLI: brew install gh"
    fi
else
    print_info "Remote branch 'origin/$MERGED_BRANCH' not found"
fi

# ä¸è¦ãªãƒªãƒ¢ãƒ¼ãƒˆå‚ç…§ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
print_info "ğŸ§¹ Cleaning up remote references..."
git remote prune origin

print_success "ğŸ‰ Auto-cleanup completed!"
print_info "ğŸ’¡ Disable: remove .husky/post-merge"
print_info "ğŸ’¡ Manual cleanup: npm run cleanup:smart"