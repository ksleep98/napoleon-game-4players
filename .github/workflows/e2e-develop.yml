# Developç’°å¢ƒE2Eãƒ†ã‚¹ãƒˆè‡ªå‹•å®Ÿè¡Œ
name: E2E Develop Tests

on:
  # developãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
  deployment_status:

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      target_url:
        description: "Develop environment URL to test"
        required: true
        default: "https://napoleon-game-dev.vercel.app"
      create_pr:
        description: "Create develop->main PR after successful tests"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

env:
  # Develop environment URL (actual Vercel develop environment)
  DEVELOP_URL: "https://napoleon-game-dev.vercel.app"

jobs:
  e2e-develop:
    runs-on: ubuntu-latest
    # ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã€ã‹ã¤developãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã®ã¿å®Ÿè¡Œ
    if: >
      (github.event.deployment_status.state == 'success' &&
       github.event.deployment.environment == 'Preview â€“ napoleon-game-4players' &&
       github.event.deployment.ref == 'develop') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: "22.14.0"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Wait for deployment to be ready
        run: |
          TARGET_URL="${{ github.event.inputs.target_url || env.DEVELOP_URL }}"
          echo "ğŸ• Waiting for deployment to be ready at: $TARGET_URL"

          max_attempts=30
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts..."

            if curl -s -f -o /dev/null --max-time 10 "$TARGET_URL"; then
              echo "âœ… Deployment is ready!"
              break
            fi

            if [ $attempt -eq $max_attempts ]; then
              echo "âŒ Deployment not ready after $max_attempts attempts"
              exit 1
            fi

            sleep 10
            attempt=$((attempt + 1))
          done

      - name: Run E2E tests against develop environment
        env:
          # Developç’°å¢ƒã®URL
          PLAYWRIGHT_BASE_URL: ${{ github.event.inputs.target_url || env.DEVELOP_URL }}
          # webServerã‚’ç„¡åŠ¹åŒ–ï¼ˆdevelopç’°å¢ƒURLã‚’ä½¿ç”¨ï¼‰
          PLAYWRIGHT_SKIP_WEBSERVER: "1"
          # E2Eãƒ†ã‚¹ãƒˆã‚’æœ‰åŠ¹åŒ–
          SKIP_E2E_TESTS: "false"
          # Test environment variables
          NODE_ENV: "test"
          NEXT_PUBLIC_SUPABASE_URL: "https://mock.supabase.co"
          NEXT_PUBLIC_SUPABASE_ANON_KEY: "mock_anon_key"
          SUPABASE_SERVICE_ROLE_KEY: "mock_service_role_key"
          # GitHub OAuthèªè¨¼ç”¨ï¼ˆGitHub Secretsã‹ã‚‰è¨­å®šï¼‰
          GITHUB_USERNAME: ${{ secrets.E2E_GITHUB_USERNAME }}
          GITHUB_PASSWORD: ${{ secrets.E2E_GITHUB_PASSWORD }}
          # å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚VERCEL_AUTH_*ã‚‚ä¿æŒ
          VERCEL_AUTH_USERNAME: ${{ secrets.E2E_GITHUB_USERNAME }}
          VERCEL_AUTH_PASSWORD: ${{ secrets.E2E_GITHUB_PASSWORD }}
        run: |
          echo "ğŸŒ Testing against develop environment: $PLAYWRIGHT_BASE_URL"
          echo "ğŸ§ª Running E2E tests..."

          # E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆdevelopç’°å¢ƒç”¨è¨­å®šï¼‰
          pnpm test:e2e:develop || {
            echo "âŒ E2E tests failed"
            exit 1
          }

          echo "âœ… All E2E tests passed!"

      - name: Generate test report summary
        if: always()
        run: |
          echo "# ğŸ§ª E2E Test Results" > e2e_summary.md
          echo "" >> e2e_summary.md

          if [ -f "test-results/results.json" ] || [ -d "test-results" ]; then
            echo "## âœ… Test Summary" >> e2e_summary.md
            echo "" >> e2e_summary.md
            echo "- **Environment**: Develop" >> e2e_summary.md
            echo "- **URL**: ${{ github.event.inputs.target_url || env.DEVELOP_URL }}" >> e2e_summary.md
            echo "- **Browser**: Chromium" >> e2e_summary.md
            echo "- **Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> e2e_summary.md
            echo "" >> e2e_summary.md

            # ãƒ†ã‚¹ãƒˆçµæœã®è©³ç´°ã‚’è¿½åŠ 
            if [ -d "test-results" ]; then
              failed_tests=$(find test-results -name "*.xml" -exec grep -l "failure" {} \; 2>/dev/null | wc -l || echo "0")
              total_tests=$(find test-results -name "*.xml" 2>/dev/null | wc -l || echo "0")

              if [ "$failed_tests" -eq 0 ] && [ "$total_tests" -gt 0 ]; then
                echo "### âœ… All tests passed! ($total_tests tests)" >> e2e_summary.md
              elif [ "$failed_tests" -gt 0 ]; then
                echo "### âŒ Some tests failed ($failed_tests/$total_tests)" >> e2e_summary.md
              else
                echo "### âš ï¸ No test results found" >> e2e_summary.md
              fi
            fi
          else
            echo "### âŒ Tests failed or no results generated" >> e2e_summary.md
          fi

          echo "" >> e2e_summary.md
          echo "---" >> e2e_summary.md
          echo "" >> e2e_summary.md
          echo "ğŸ”— **Playwright Report**: [View HTML Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> e2e_summary.md
          echo "" >> e2e_summary.md

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: develop-e2e-results
          path: |
            test-results/
            playwright-report/
            e2e_summary.md
          retention-days: 14

  create-release-pr:
    needs: e2e-develop
    runs-on: ubuntu-latest
    if: >
      needs.e2e-develop.result == 'success' &&
      (github.event.inputs.create_pr != 'false' || github.event.inputs.create_pr == null) &&
      github.ref == 'refs/heads/develop'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Download E2E test results
        uses: actions/download-artifact@v4
        with:
          name: develop-e2e-results
          path: ./e2e-results

      - name: Check if release PR already exists
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        id: check_pr
        run: |
          existing_pr=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number // empty')
          if [ -n "$existing_pr" ]; then
            echo "existing_pr=$existing_pr" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ Found existing release PR #$existing_pr"
          else
            echo "ğŸ“‹ No existing release PR found"
          fi

      - name: Create or update release PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # E2Eãƒ†ã‚¹ãƒˆçµæœã‚’èª­ã¿è¾¼ã¿
          if [ -f "./e2e-results/e2e_summary.md" ]; then
            E2E_RESULTS=$(cat ./e2e-results/e2e_summary.md)
          else
            E2E_RESULTS="# ğŸ§ª E2E Test Results

          ## âœ… Test Summary
          - **Status**: Passed
          - **Environment**: Develop
          - **Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          "
          fi

          # Get recent changes since last main
          echo "## ğŸ‰ Ready for Production Release" > pr_body.md
          echo "" >> pr_body.md
          echo "This PR contains tested changes from the develop branch, ready to be merged to main." >> pr_body.md
          echo "" >> pr_body.md

          # Add recent commits
          echo "### ğŸ“‹ Recent Changes" >> pr_body.md
          echo "" >> pr_body.md
          git log --oneline --no-merges main..develop | head -n 10 | while read line; do
            commit_hash=$(echo "$line" | cut -d' ' -f1)
            commit_msg=$(echo "$line" | cut -d' ' -f2-)

            if [[ $commit_msg == feat:* ]]; then
              echo "- âœ¨ **New**: ${commit_msg#feat: } (\`$commit_hash\`)" >> pr_body.md
            elif [[ $commit_msg == fix:* ]]; then
              echo "- ğŸ› **Fix**: ${commit_msg#fix: } (\`$commit_hash\`)" >> pr_body.md
            elif [[ $commit_msg == docs:* ]]; then
              echo "- ğŸ“š **Docs**: ${commit_msg#docs: } (\`$commit_hash\`)" >> pr_body.md
            else
              echo "- ğŸ”§ $commit_msg (\`$commit_hash\`)" >> pr_body.md
            fi
          done
          echo "" >> pr_body.md

          # Add E2E test results
          echo "### ğŸ§ª Quality Assurance" >> pr_body.md
          echo "" >> pr_body.md
          echo "$E2E_RESULTS" >> pr_body.md
          echo "" >> pr_body.md

          echo "### ğŸš€ Deployment Information" >> pr_body.md
          echo "" >> pr_body.md
          echo "- **Source Branch**: \`develop\`" >> pr_body.md
          echo "- **Target Branch**: \`main\`" >> pr_body.md
          echo "- **E2E Tests**: âœ… Passed on develop environment" >> pr_body.md
          echo "- **Auto-merge**: Ready for production deployment" >> pr_body.md
          echo "" >> pr_body.md
          echo "---" >> pr_body.md
          echo "" >> pr_body.md
          echo "ğŸ¤– *This PR was automatically created after successful E2E testing on the develop environment.*" >> pr_body.md

          # Create or update PR
          if [ -n "${{ steps.check_pr.outputs.existing_pr }}" ]; then
            # Update existing PR
            PR_NUMBER="${{ steps.check_pr.outputs.existing_pr }}"
            gh pr edit $PR_NUMBER --body "$(cat pr_body.md)"

            # Add comment with new E2E results
            gh pr comment $PR_NUMBER --body "## ğŸ”„ Updated E2E Test Results

          $E2E_RESULTS

          **Test Run**: [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          "

            echo "âœ… Updated existing release PR #$PR_NUMBER"
          else
            # Create new PR
            PR_URL=$(gh pr create \
              --base main \
              --head develop \
              --title "ğŸš€ Release: Deploy to Production ($(date +%Y-%m-%d))" \
              --body "$(cat pr_body.md)" \
              --label "release,auto-generated")

            echo "âœ… Created new release PR: $PR_URL"
          fi

      - name: Notify on success
        if: success()
        run: |
          echo "ğŸ‰ E2E tests passed on develop environment!"
          echo "ğŸ“‹ Release PR has been created/updated for main branch"
          echo "ğŸš€ Ready for production deployment"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ E2E tests failed on develop environment"
          echo "ğŸš« Release PR will not be created until tests pass"
