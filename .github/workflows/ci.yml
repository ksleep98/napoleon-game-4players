name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.14.0'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci --prefer-offline --no-audit --no-fund

    - name: Verify Biome installation
      run: |
        echo "ğŸ”§ Verifying Biome installation..."
        if ! npx @biomejs/biome --version 2>/dev/null; then
          echo "âš ï¸  Biome binary issue detected, reinstalling..."
          rm -rf node_modules/@biomejs
          npm install @biomejs/biome@latest --force
          echo "âœ… Biome reinstalled"
        fi
        npx @biomejs/biome --version

    - name: TypeScript check
      run: |
        echo "ğŸ”§ Running TypeScript type check..."
        npx tsc --noEmit --skipLibCheck

    - name: Biome lint check
      run: |
        echo "ğŸ” Running Biome lint check..."
        npx @biomejs/biome check . --reporter=compact

    - name: Biome format check
      run: |
        echo "ğŸ“ Running Biome format check..."
        npx @biomejs/biome format . --check

    - name: Build check
      if: success()
      env:
        NEXT_PUBLIC_SUPABASE_URL: "https://mock.supabase.co"
        NEXT_PUBLIC_SUPABASE_ANON_KEY: "mock_anon_key"
        NEXT_TELEMETRY_DISABLED: "1"
      run: |
        echo "ğŸ—ï¸ Build verification..."
        npm run build