name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

jobs:
  ci-pipeline:
    runs-on: ubuntu-latest
    # Optimized CI pipeline for fast feedback
    # Skip CI for release PRs since they already run on push to develop
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && !contains(github.event.pull_request.title, 'üöÄ Release'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Only fetch current commit for speed
          fetch-depth: 1

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: "22.14.0"
          cache: "pnpm"

      - name: Install dependencies and fix Biome
        run: |
          echo "üì¶ Installing dependencies..."
          pnpm install --frozen-lockfile

          echo "üîß Fixing Biome installation for Linux..."
          # Remove potentially corrupted Biome installation
          rm -rf node_modules/@biomejs/biome node_modules/.bin/biome 2>/dev/null || true

          # Fresh install of Biome with correct platform binary
          pnpm add @biomejs/biome@latest

          # Verify installation
          if npx @biomejs/biome --version; then
            echo "‚úÖ Biome installation verified"
          else
            echo "‚ö†Ô∏è Biome installation failed, will use TypeScript-only checks"
            echo "BIOME_FAILED=true" >> $GITHUB_ENV
          fi

      - name: Run quality checks in parallel
        run: |
          # Run multiple checks in parallel using background processes
          echo "üöÄ Starting parallel quality checks..."

          # Check if Biome is available, otherwise skip lint/format checks
          if [ "$BIOME_FAILED" = "true" ]; then
            echo "‚ö†Ô∏è Biome unavailable, running TypeScript and test checks..."

            # Run type check and tests when Biome is not available
            pnpm type-check &
            PID_TYPE=$!

            pnpm test:ci &
            PID_TEST=$!

            wait $PID_TYPE
            TYPE_RESULT=$?

            wait $PID_TEST
            TEST_RESULT=$?

            echo "‚úÖ Type check: $([ $TYPE_RESULT -eq 0 ] && echo "PASSED" || echo "FAILED")"
            echo "‚úÖ Tests: $([ $TEST_RESULT -eq 0 ] && echo "PASSED" || echo "FAILED")"

            if [ $TYPE_RESULT -ne 0 ] || [ $TEST_RESULT -ne 0 ]; then
              echo "‚ùå One or more checks failed"
              exit 1
            fi

            echo "üéâ Type check and tests passed! (Biome checks skipped)"
          else
            # Run full quality checks in parallel
            pnpm lint &
            PID_LINT=$!

            pnpm type-check &
            PID_TYPE=$!

            pnpm format:check &
            PID_FORMAT=$!

            pnpm test:ci &
            PID_TEST=$!

            # Wait for all processes and capture exit codes
            wait $PID_LINT
            LINT_RESULT=$?

            wait $PID_TYPE
            TYPE_RESULT=$?

            wait $PID_FORMAT
            FORMAT_RESULT=$?

            wait $PID_TEST
            TEST_RESULT=$?

            # Report results
            echo "‚úÖ Lint check: $([ $LINT_RESULT -eq 0 ] && echo "PASSED" || echo "FAILED")"
            echo "‚úÖ Type check: $([ $TYPE_RESULT -eq 0 ] && echo "PASSED" || echo "FAILED")"
            echo "‚úÖ Format check: $([ $FORMAT_RESULT -eq 0 ] && echo "PASSED" || echo "FAILED")"
            echo "‚úÖ Tests: $([ $TEST_RESULT -eq 0 ] && echo "PASSED" || echo "FAILED")"

            # Exit with error if any check failed
            if [ $LINT_RESULT -ne 0 ] || [ $TYPE_RESULT -ne 0 ] || [ $FORMAT_RESULT -ne 0 ] || [ $TEST_RESULT -ne 0 ]; then
              echo "‚ùå One or more quality checks failed"
              exit 1
            fi

            echo "üéâ All quality checks passed!"
          fi

      - name: Fast build check
        env:
          NEXT_PUBLIC_SUPABASE_URL: "https://mock.supabase.co"
          NEXT_PUBLIC_SUPABASE_ANON_KEY: "mock_anon_key"
          SUPABASE_SERVICE_ROLE_KEY: "mock_service_role_key"
          # Optimize build for CI
          NODE_ENV: "production"
          NEXT_TELEMETRY_DISABLED: "1"
        run: |
          echo "üèóÔ∏è Fast build verification..."
          pnpm build

  e2e-tests:
    runs-on: ubuntu-latest
    # Only run E2E tests on push to main/develop or specific PR labels
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'e2e-test'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: "22.14.0"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Build application
        env:
          NEXT_PUBLIC_SUPABASE_URL: "https://mock.supabase.co"
          NEXT_PUBLIC_SUPABASE_ANON_KEY: "mock_anon_key"
          SUPABASE_SERVICE_ROLE_KEY: "mock_service_role_key"
          NODE_ENV: "production"
          NEXT_TELEMETRY_DISABLED: "1"
        run: pnpm build

      - name: Run comprehensive game flow E2E test
        env:
          NEXT_PUBLIC_SUPABASE_URL: "https://mock.supabase.co"
          NEXT_PUBLIC_SUPABASE_ANON_KEY: "mock_anon_key"
          SUPABASE_SERVICE_ROLE_KEY: "mock_service_role_key"
          NODE_ENV: "test"
          CI: "true"
          # Playwright will start dev server automatically
          PORT: "3000"
          NEXT_TELEMETRY_DISABLED: "1"
        run: |
          echo "üöÄ Running comprehensive game flow E2E test..."
          echo "üéÆ Test: Napoleon selection ‚Üí Card exchange ‚Üí Playing ‚Üí Result"
          echo "‚è≥ Playwright webServer will start dev server automatically"
          echo "üìù This single test validates the entire game flow end-to-end"
          pnpm test:e2e:ci:comprehensive

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 7
